<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Teachable Machine Mask Detection</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
<h2>Teachable Machine – Mask Detection</h2>
<button id="startBtn">Start</button>

<div id="webcam-container"></div>
<div id="label-container"></div>

<!-- 1️⃣ TensorFlow (ต้องมาก่อน) -->
<script src="https://unpkg.com/@tensorflow/tfjs@4.16.0/dist/tf.min.js"></script>

<!-- 2️⃣ Teachable Machine Image -->
<script src="https://unpkg.com/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>

<!-- 3️⃣ โค้ดเรา -->
<script>
window.onload = () => {
    document.getElementById("startBtn").onclick = init;
};

const URL = "./my_model/";

let model, webcam, labelContainer, maxPredictions;

async function init() {
    try {
        if (!window.tmImage) {
            alert("tmImage ยังไม่โหลด ❌ (CDN)");
            return;
        }

        const modelURL = URL + "model.json";
        const metadataURL = URL + "metadata.json";

        model = await tmImage.load(modelURL, metadataURL);
        maxPredictions = model.getTotalClasses();

        webcam = new tmImage.Webcam(200, 200, true);
        await webcam.setup();   // ขอ permission กล้อง
        await webcam.play();

        document.getElementById("webcam-container").innerHTML = "";
        document.getElementById("webcam-container").appendChild(webcam.canvas);

        labelContainer = document.getElementById("label-container");
        labelContainer.innerHTML = "";

        for (let i = 0; i < maxPredictions; i++) {
            labelContainer.appendChild(document.createElement("div"));
        }

        window.requestAnimationFrame(loop);

    } catch (e) {
        alert("ERROR: " + e);
        console.error(e);
    }
}

async function loop() {
    webcam.update();
    await predict();
    requestAnimationFrame(loop);
}

async function predict() {
    const prediction = await model.predict(webcam.canvas);
    for (let i = 0; i < maxPredictions; i++) {
        labelContainer.childNodes[i].innerText =
            prediction[i].className + ": " +
            prediction[i].probability.toFixed(2);
    }
}
</script>
</body>
</html>
